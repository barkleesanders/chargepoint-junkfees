<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChargePoint Junk Fee Scanner</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--green:#37A25B;--dark:#111827;--gray:#6b7280;--light:#f9fafb;--red:#dc2626;--yellow:#fef3c7;--card:#fff;--radius:12px;--shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06)}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--light);color:var(--dark);line-height:1.6}
a{color:var(--green)}

/* Header */
.hero{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);color:#fff;padding:60px 20px;text-align:center}
.hero h1{font-size:2.2rem;margin-bottom:8px;font-weight:800}
.hero h1 span{color:var(--green)}
.hero p{font-size:1.1rem;color:#94a3b8;max-width:600px;margin:0 auto}

/* Container */
.container{max-width:820px;margin:0 auto;padding:20px}

/* Cards */
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px;margin:20px 0}
.card h2{font-size:1.25rem;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.card h2 .num{background:var(--green);color:#fff;width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:.85rem;flex-shrink:0}

/* Steps */
.steps{display:grid;gap:12px}
.step{background:var(--light);border-radius:8px;padding:14px 16px;font-size:.93rem;color:#374151}
.step code{background:#e5e7eb;padding:2px 6px;border-radius:4px;font-size:.85rem;font-family:'SF Mono',Consolas,monospace}

/* Input */
.token-wrap{display:flex;gap:10px;margin-top:12px}
.token-wrap input{flex:1;padding:12px 16px;border:2px solid #d1d5db;border-radius:8px;font-size:1rem;font-family:'SF Mono',Consolas,monospace;outline:none;transition:border-color .2s}
.token-wrap input:focus{border-color:var(--green)}
.token-wrap input::placeholder{color:#9ca3af;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
.btn{padding:12px 28px;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .15s}
.btn-primary{background:var(--green);color:#fff}
.btn-primary:hover{background:#2d8a4a}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-outline{background:transparent;border:2px solid var(--green);color:var(--green)}
.btn-outline:hover{background:var(--green);color:#fff}

/* Progress */
#progress-section{display:none}
.progress-bar-wrap{background:#e5e7eb;border-radius:99px;height:10px;overflow:hidden;margin:10px 0}
.progress-bar{background:var(--green);height:100%;width:0%;transition:width .3s;border-radius:99px}
.progress-text{font-size:.9rem;color:var(--gray)}
.progress-log{margin-top:12px;max-height:180px;overflow-y:auto;background:#f1f5f9;border-radius:8px;padding:12px;font-size:.82rem;font-family:'SF Mono',Consolas,monospace;color:#475569;line-height:1.7}

/* Results */
#results-section{display:none}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:20px}
.stat-card{background:var(--light);border-radius:8px;padding:18px;text-align:center}
.stat-card .num{font-size:1.8rem;font-weight:800;color:var(--green)}
.stat-card .num.red{color:var(--red)}
.stat-card .label{font-size:.85rem;color:var(--gray);margin-top:2px}

/* Fee table */
.fee-table{width:100%;border-collapse:collapse;font-size:.9rem}
.fee-table th{text-align:left;padding:10px 12px;background:#f1f5f9;border-bottom:2px solid #e5e7eb;color:var(--gray);font-weight:600;font-size:.8rem;text-transform:uppercase;letter-spacing:.03em}
.fee-table td{padding:10px 12px;border-bottom:1px solid #f1f5f9}
.fee-table tr:hover td{background:#fafafa}
.fee-tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.75rem;font-weight:600}
.fee-tag.parking{background:#fef3c7;color:#92400e}
.fee-tag.flat{background:#fce7f3;color:#9d174d}
.fee-tag.min{background:#e0e7ff;color:#3730a3}
.fee-tag.hidden{background:#fee2e2;color:#991b1b}
.amount-red{color:var(--red);font-weight:700}

/* Receipt detail */
.receipt-detail{background:var(--light);border-radius:8px;padding:16px;margin:12px 0;border-left:4px solid var(--red)}
.receipt-detail h4{font-size:.95rem;margin-bottom:8px}
.receipt-detail .line-item{display:flex;justify-content:space-between;padding:4px 0;font-size:.88rem}
.receipt-detail .line-item.junk{color:var(--red);font-weight:600;background:var(--yellow);padding:4px 8px;border-radius:4px;margin:2px -8px}

/* Actions */
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}

/* Privacy */
.privacy{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:var(--radius);padding:20px;margin:20px 0;font-size:.88rem;color:#166534}
.privacy h3{font-size:1rem;margin-bottom:8px}
.privacy ul{padding-left:20px}

/* Footer */
footer{text-align:center;padding:30px;color:var(--gray);font-size:.85rem}

/* Print styles */
@media print{
  .hero,.card:has(#token-input),.actions .btn-outline,#progress-section,.privacy,footer,.no-print{display:none!important}
  .card{box-shadow:none;border:1px solid #e5e7eb}
  body{background:#fff}
}

/* Responsive */
@media(max-width:640px){
  .hero h1{font-size:1.6rem}
  .token-wrap{flex-direction:column}
  .summary-grid{grid-template-columns:1fr 1fr}
  .fee-table{font-size:.8rem}
  .fee-table th,.fee-table td{padding:8px 6px}
}
</style>
</head>
<body>

<div class="hero">
  <h1>Did ChargePoint <span>overcharge</span> you?</h1>
  <p>Scan your account for hidden fees, idle charges, and session surcharges. Your data never leaves your browser.</p>
</div>

<div class="container">

  <div class="card">
    <h2><span class="num">1</span> Get your ChargePoint session token</h2>
    <div class="steps">
      <div class="step">Log in to <a href="https://driver.chargepoint.com" target="_blank" rel="noopener">driver.chargepoint.com</a></div>
      <div class="step">Open Developer Tools: press <code>F12</code> (Windows) or <code>Cmd+Option+I</code> (Mac)</div>
      <div class="step">Click the <strong>Application</strong> tab, then <strong>Cookies</strong> &rarr; <code>https://driver.chargepoint.com</code></div>
      <div class="step">Find <code>auth-session</code>, double-click its <strong>Value</strong>, and copy it (<code>Ctrl+C</code> / <code>Cmd+C</code>)</div>
    </div>
  </div>

  <div class="card">
    <h2><span class="num">2</span> Paste your token and scan</h2>
    <p style="font-size:.9rem;color:var(--gray);margin-bottom:8px">Your token is only used to fetch your data. It expires in ~2 hours and is never stored.</p>
    <div class="token-wrap">
      <input type="password" id="token-input" placeholder="Paste your auth-session token here..." autocomplete="off" spellcheck="false">
      <button class="btn btn-primary" id="scan-btn" onclick="startScan()">Scan My Account</button>
    </div>
    <p id="token-error" style="color:var(--red);font-size:.85rem;margin-top:8px;display:none"></p>
  </div>

  <div class="card" id="progress-section">
    <h2><span class="num">...</span> Scanning your account</h2>
    <div class="progress-bar-wrap"><div class="progress-bar" id="progress-bar"></div></div>
    <p class="progress-text" id="progress-text">Starting...</p>
    <div class="progress-log" id="progress-log"></div>
  </div>

  <div id="results-section">
    <div class="card">
      <h2 style="color:var(--red)">Junk Fee Report</h2>
      <div class="summary-grid" id="summary-grid"></div>
      <div class="actions">
        <button class="btn btn-primary" onclick="window.print()">Print / Save as PDF</button>
        <button class="btn btn-outline no-print" onclick="downloadCSV()">Download CSV</button>
      </div>
    </div>

    <div class="card" id="fee-breakdown-card" style="display:none">
      <h2 style="color:var(--red)">Sessions with Extra Fees</h2>
      <div style="overflow-x:auto">
        <table class="fee-table" id="fee-table">
          <thead><tr>
            <th>Date</th><th>Station</th><th>Fee Type</th><th>Energy Cost</th><th>Extra Fees</th><th>Total</th>
          </tr></thead>
          <tbody id="fee-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" id="detail-card" style="display:none">
      <h2>Itemized Receipt Evidence</h2>
      <div id="receipt-details"></div>
    </div>

    <div class="card">
      <h2>All Sessions</h2>
      <div style="overflow-x:auto">
        <table class="fee-table" id="all-table">
          <thead><tr>
            <th>Date</th><th>Station</th><th>Energy</th><th>Duration</th><th>Price Model</th><th>Total</th>
          </tr></thead>
          <tbody id="all-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="privacy">
    <h3>Privacy &amp; Security</h3>
    <ul>
      <li>Your token is sent only to our Cloudflare edge proxy, which forwards it to ChargePoint's API.</li>
      <li>Nothing is stored, logged, or persisted. All processing happens in memory.</li>
      <li>The auth token expires in ~2 hours. After scanning, it has no further value.</li>
      <li>Analysis runs entirely in your browser. The server only proxies API requests.</li>
      <li>This tool is open source. <a href="https://github.com/barkleesanders/chargepoint-junkfees" target="_blank">View the code</a>.</li>
    </ul>
  </div>

</div>

<footer>
  Built for transparency. Not affiliated with ChargePoint.
</footer>

<script>
const MONTHS = ['','January','February','March','April','May','June','July','August','September','October','November','December'];
const ALL_YEARS = [2018,2019,2020,2021,2022,2023,2024,2025,2026];
let allReceipts = [];
let junkSessions = [];

function $(id) { return document.getElementById(id); }

function log(msg) {
  const el = $('progress-log');
  el.textContent += msg + '\n';
  el.scrollTop = el.scrollHeight;
}

function setProgress(pct, text) {
  $('progress-bar').style.width = pct + '%';
  if (text) $('progress-text').textContent = text;
}

async function api(endpoint, body) {
  const resp = await fetch('/api/' + endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({ error: 'Request failed' }));
    throw new Error(err.error || `HTTP ${resp.status}`);
  }
  return resp.json();
}

async function batchFetch(items, fn, concurrency = 8) {
  const results = [];
  for (let i = 0; i < items.length; i += concurrency) {
    const batch = items.slice(i, i + concurrency);
    const batchResults = await Promise.allSettled(batch.map(fn));
    results.push(...batchResults);
  }
  return results;
}

async function startScan() {
  const token = $('token-input').value.trim();
  const errEl = $('token-error');
  errEl.style.display = 'none';

  // Validate
  if (!token) { errEl.textContent = 'Please paste your auth-session token.'; errEl.style.display = 'block'; return; }
  const parts = token.split('.');
  if (parts.length !== 3) { errEl.textContent = 'That doesn\'t look like a valid auth-session token. It should be a long string with two dots in it (JWT format).'; errEl.style.display = 'block'; return; }

  // Decode JWT to check expiry
  try {
    const payload = JSON.parse(atob(parts[1]));
    if (payload.exp && payload.exp * 1000 < Date.now()) {
      errEl.textContent = 'This token has expired. Please log in to ChargePoint again and copy a fresh token.';
      errEl.style.display = 'block';
      return;
    }
  } catch(e) { /* ignore decode errors */ }

  $('scan-btn').disabled = true;
  $('scan-btn').textContent = 'Scanning...';
  $('progress-section').style.display = 'block';
  $('results-section').style.display = 'none';
  $('progress-log').textContent = '';

  allReceipts = [];
  junkSessions = [];

  try {
    // Phase 1: Find months with data
    log('Phase 1: Scanning all months for activity...');
    setProgress(5, 'Scanning months...');

    const monthsToCheck = [];
    const now = new Date();
    for (const year of ALL_YEARS) {
      for (let m = 1; m <= 12; m++) {
        if (year > now.getFullYear()) continue;
        if (year === now.getFullYear() && m > now.getMonth() + 1) continue;
        monthsToCheck.push({ month: m, year });
      }
    }

    const monthResults = await batchFetch(monthsToCheck, async (item) => {
      const data = await api('statement', { token, month: item.month, year: item.year });
      return { ...item, data };
    }, 12);

    const activeSessions = [];
    let monthCount = 0;

    for (let i = 0; i < monthResults.length; i++) {
      const result = monthResults[i];
      if (result.status !== 'fulfilled') continue;
      const { month, year, data } = result.value;
      const td = data.transactionDetails || {};

      const sessions = [];
      for (const key of ['personal', 'personalFailed']) {
        const section = td[key];
        if (section && section.sessions) {
          for (const s of section.sessions) sessions.push({ ...s, section: key });
        }
      }
      // business and home are arrays of groups
      for (const key of ['business', 'home']) {
        const groups = td[key];
        if (Array.isArray(groups)) {
          for (const g of groups) {
            if (g.sessions) {
              for (const s of g.sessions) sessions.push({ ...s, section: key, company: g.companyName });
            }
          }
        }
      }

      if (sessions.length > 0) {
        monthCount++;
        log(`  ${MONTHS[month]} ${year}: ${sessions.length} session(s)`);
        for (const s of sessions) {
          activeSessions.push({ id: s.vehicleChargeId, date: s.endTime, station: s.stationName, amount: s.totalAmount, energy: s.energy, duration: s.duration, type: s.type, section: s.section, company: s.company });
        }
      }
    }

    // Deduplicate
    const seen = new Set();
    const uniqueSessions = activeSessions.filter(s => { if (seen.has(s.id)) return false; seen.add(s.id); return true; });

    log(`\nFound ${uniqueSessions.length} sessions across ${monthCount} months.`);
    setProgress(40, `Fetching ${uniqueSessions.length} detailed receipts...`);

    // Phase 2: Fetch detailed receipts
    log('\nPhase 2: Fetching itemized receipts...');
    let receiptsDone = 0;

    const receiptResults = await batchFetch(uniqueSessions, async (sess) => {
      const receipt = await api('receipt', { token, sessionId: sess.id });
      receiptsDone++;
      const pct = 40 + Math.round((receiptsDone / uniqueSessions.length) * 50);
      setProgress(pct, `Receipts: ${receiptsDone}/${uniqueSessions.length}`);
      return { sess, receipt };
    }, 6);

    // Phase 3: Analyze
    log('\nPhase 3: Analyzing for junk fees...');
    setProgress(92, 'Analyzing receipts...');

    for (const result of receiptResults) {
      if (result.status !== 'fulfilled') continue;
      const { sess, receipt } = result.value;
      if (!receipt || !receipt.line_item_details) continue;

      const li = receipt.line_item_details;
      const payment = receipt.payment || {};
      const fees = [];

      // Parking/idle fees
      for (const p of (li.parking || [])) {
        const cost = parseFloat(p.line_item_cost || '0');
        if (cost > 0) {
          fees.push({ type: 'Parking/Idle Fee', amount: cost, detail: `${p.time || ''} @ $${p.unit_price}${p.unit_price_unit}`, cssClass: 'parking' });
        }
      }

      // Flat session fee
      if (li.flat_fee && parseFloat(li.flat_fee.line_item_cost || '0') > 0) {
        fees.push({ type: 'Flat Session Fee', amount: parseFloat(li.flat_fee.line_item_cost), detail: `$${li.flat_fee.flat_fee} per session`, cssClass: 'flat' });
      }

      // Minimum charge adjustment
      if (li.min_adj && parseFloat(li.min_adj.total_adj || '0') > 0) {
        fees.push({ type: 'Minimum Charge Adj', amount: parseFloat(li.min_adj.total_adj), detail: `Session minimum: $${li.min_adj.subsess_min}`, cssClass: 'min' });
      }

      // Pricing info
      const pricing = [];
      for (const e of (li.energy || [])) {
        if (e.unit_price_unit && e.unit_price_unit.includes('/hr')) pricing.push(`$${e.unit_price}/hr (time-based)`);
        else if (e.unit_price_unit && e.unit_price_unit.includes('/kWh')) pricing.push(`$${e.unit_price}/kWh`);
      }

      const energyCost = (li.energy || []).reduce((sum, e) => sum + parseFloat(e.line_item_cost || '0'), 0);
      const junkTotal = fees.reduce((sum, f) => sum + f.amount, 0);

      const info = {
        sessionId: sess.id,
        date: sess.date || '',
        station: receipt.station?.name || sess.station || '',
        company: receipt.company?.name || sess.company || '',
        total: parseFloat(li.total || '0'),
        energyDispensed: li.energy_dispensed || '0',
        energyCost,
        duration: sess.duration,
        type: sess.type,
        pricing,
        fees,
        junkTotal,
        lineItems: li,
        maxAdj: li.max_adj || null,
      };

      allReceipts.push(info);
      if (junkTotal > 0) junkSessions.push(info);
    }

    log(`\nDone! ${junkSessions.length} session(s) with extra fees found.`);
    setProgress(100, 'Complete!');

    // Render results
    renderResults();

  } catch (err) {
    log(`\nError: ${err.message}`);
    errEl.textContent = err.message.includes('Invalid token') || err.message.includes('401')
      ? 'Authentication failed. Please check your token and try again.'
      : `Error: ${err.message}`;
    errEl.style.display = 'block';
  } finally {
    $('scan-btn').disabled = false;
    $('scan-btn').textContent = 'Scan My Account';
  }
}

function fmtCurrency(n) { return '$' + parseFloat(n || 0).toFixed(2); }

function fmtDuration(seconds) {
  if (!seconds) return '-';
  const s = parseInt(seconds);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const parts = [];
  if (h) parts.push(h + 'h');
  if (m) parts.push(m + 'm');
  return parts.join(' ') || '<1m';
}

function fmtEnergy(kwh) {
  if (!kwh) return '-';
  return parseFloat(kwh).toFixed(1) + ' kWh';
}

function fmtDate(dateStr) {
  if (!dateStr) return '-';
  try {
    const d = new Date(dateStr.replace(/-/g, '/').replace(' ', 'T'));
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  } catch { return dateStr.substring(0, 10); }
}

function renderResults() {
  $('results-section').style.display = 'block';

  const totalSessions = allReceipts.length;
  const totalJunkFees = junkSessions.reduce((s, r) => s + r.junkTotal, 0);
  const totalSpent = allReceipts.reduce((s, r) => s + r.total, 0);
  const totalEnergy = allReceipts.reduce((s, r) => s + parseFloat(r.energyDispensed || 0), 0);

  $('summary-grid').innerHTML = `
    <div class="stat-card"><div class="num">${totalSessions}</div><div class="label">Total Sessions</div></div>
    <div class="stat-card"><div class="num">${fmtCurrency(totalSpent)}</div><div class="label">Total Spent</div></div>
    <div class="stat-card"><div class="num red">${junkSessions.length}</div><div class="label">Sessions w/ Extra Fees</div></div>
    <div class="stat-card"><div class="num red">${fmtCurrency(totalJunkFees)}</div><div class="label">Total Extra Fees</div></div>
  `;

  // Fee breakdown table
  if (junkSessions.length > 0) {
    $('fee-breakdown-card').style.display = 'block';
    $('detail-card').style.display = 'block';

    let tbody = '';
    for (const r of junkSessions.sort((a, b) => b.junkTotal - a.junkTotal)) {
      const feeTypes = r.fees.map(f => `<span class="fee-tag ${f.cssClass}">${f.type}</span>`).join(' ');
      tbody += `<tr>
        <td>${fmtDate(r.date)}</td>
        <td>${r.station}</td>
        <td>${feeTypes}</td>
        <td>${fmtCurrency(r.energyCost)}</td>
        <td class="amount-red">${fmtCurrency(r.junkTotal)}</td>
        <td>${fmtCurrency(r.total)}</td>
      </tr>`;
    }
    $('fee-tbody').innerHTML = tbody;

    // Detailed receipt evidence
    let details = '';
    for (let i = 0; i < junkSessions.length; i++) {
      const r = junkSessions[i];
      let lineItems = '';

      for (const e of (r.lineItems.energy || [])) {
        lineItems += `<div class="line-item"><span>Energy: ${e.units || ''} @ $${e.unit_price}${e.unit_price_unit} (${e.time || ''})</span><span>${fmtCurrency(e.line_item_cost)}</span></div>`;
      }
      for (const p of (r.lineItems.parking || [])) {
        const cost = parseFloat(p.line_item_cost || 0);
        const cls = cost > 0 ? ' junk' : '';
        lineItems += `<div class="line-item${cls}"><span>Parking/Idle: ${p.time || ''} @ $${p.unit_price}${p.unit_price_unit}</span><span>${fmtCurrency(p.line_item_cost)}${cost > 0 ? ' JUNK FEE' : ''}</span></div>`;
      }
      if (r.lineItems.flat_fee && parseFloat(r.lineItems.flat_fee.line_item_cost || 0) > 0) {
        lineItems += `<div class="line-item junk"><span>Flat Session Fee ($${r.lineItems.flat_fee.flat_fee}/session)</span><span>${fmtCurrency(r.lineItems.flat_fee.line_item_cost)} JUNK FEE</span></div>`;
      }
      if (r.lineItems.min_adj && parseFloat(r.lineItems.min_adj.total_adj || 0) > 0) {
        lineItems += `<div class="line-item junk"><span>Minimum Charge Adjustment (min: $${r.lineItems.min_adj.subsess_min})</span><span>+${fmtCurrency(r.lineItems.min_adj.total_adj)} JUNK FEE</span></div>`;
      }
      if (r.maxAdj) {
        lineItems += `<div class="line-item"><span>Session Cap Adjustment (max: $${r.maxAdj.subsess_max})</span><span>${fmtCurrency(r.maxAdj.total_adj)}</span></div>`;
      }

      details += `
        <div class="receipt-detail">
          <h4>Exhibit ${i+1}: ${r.station} &mdash; ${fmtDate(r.date)}</h4>
          <p style="font-size:.85rem;color:var(--gray);margin-bottom:8px">Session ${r.sessionId} | Operator: ${r.company} | Energy: ${fmtEnergy(r.energyDispensed)}</p>
          ${lineItems}
          <div class="line-item" style="border-top:2px solid #e5e7eb;margin-top:6px;padding-top:6px;font-weight:700"><span>Total Charged</span><span>${fmtCurrency(r.total)}</span></div>
          <div class="line-item junk" style="margin-top:4px"><span>Extra Fees in This Receipt</span><span>${fmtCurrency(r.junkTotal)}</span></div>
        </div>`;
    }
    $('receipt-details').innerHTML = details;
  }

  // All sessions table
  let allTbody = '';
  for (const r of allReceipts.sort((a, b) => (b.date || '').localeCompare(a.date || ''))) {
    const priceModel = r.pricing.length ? r.pricing.join(', ') : '-';
    const hasJunk = r.junkTotal > 0;
    allTbody += `<tr${hasJunk ? ' style="background:#fef2f2"' : ''}>
      <td>${fmtDate(r.date)}</td>
      <td>${r.station}${hasJunk ? ' <span class="fee-tag hidden">FEES</span>' : ''}</td>
      <td>${fmtEnergy(r.energyDispensed)}</td>
      <td>${fmtDuration(r.duration)}</td>
      <td>${priceModel}</td>
      <td>${fmtCurrency(r.total)}</td>
    </tr>`;
  }
  $('all-tbody').innerHTML = allTbody;

  // Scroll to results
  $('results-section').scrollIntoView({ behavior: 'smooth' });
}

function downloadCSV() {
  let csv = 'Date,Station,Operator,Session ID,Energy (kWh),Total,Energy Cost,Junk Fees,Fee Types\n';
  for (const r of allReceipts) {
    const feeTypes = r.fees.map(f => f.type).join('; ');
    csv += `"${r.date}","${r.station}","${r.company}","${r.sessionId}","${r.energyDispensed}","${r.total}","${r.energyCost.toFixed(2)}","${r.junkTotal.toFixed(2)}","${feeTypes}"\n`;
  }
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'chargepoint_junkfee_audit.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
